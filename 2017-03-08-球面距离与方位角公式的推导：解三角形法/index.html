<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="dothinking">
        <link rel="canonical" href="https://dothinking.github.io/2017-03-08-%E7%90%83%E9%9D%A2%E8%B7%9D%E7%A6%BB%E4%B8%8E%E6%96%B9%E4%BD%8D%E8%A7%92%E5%85%AC%E5%BC%8F%E7%9A%84%E6%8E%A8%E5%AF%BC%EF%BC%9A%E8%A7%A3%E4%B8%89%E8%A7%92%E5%BD%A2%E6%B3%95/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>球面距离与方位角公式的推导：解三角形法 - 格致</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">格致</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">分类 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../categories/CAD-CAE%20integration/" class="dropdown-item">CAD/CAE integration</a>
</li>
                                    
<li>
    <a href="../categories/devops/" class="dropdown-item">devops</a>
</li>
                                    
<li>
    <a href="../categories/feeling/" class="dropdown-item">feeling</a>
</li>
                                    
<li>
    <a href="../categories/finite%20element%20analysis/" class="dropdown-item">finite element analysis</a>
</li>
                                    
<li>
    <a href="../categories/machine%20learning/" class="dropdown-item">machine learning</a>
</li>
                                    
<li>
    <a href="../categories/mathematics/" class="dropdown-item">mathematics</a>
</li>
                                    
<li>
    <a href="../categories/numeric%20calculation/" class="dropdown-item">numeric calculation</a>
</li>
                                    
<li>
    <a href="../categories/optimization/" class="dropdown-item">optimization</a>
</li>
                                    
<li>
    <a href="../categories/plasticity%20theory/" class="dropdown-item">plasticity theory</a>
</li>
                                    
<li>
    <a href="../categories/process%20automation/" class="dropdown-item">process automation</a>
</li>
                                    
<li>
    <a href="../categories/python-vba-cpp/" class="dropdown-item">python/vba/cpp</a>
</li>
                                    
<li>
    <a href="../categories/web%20development/" class="dropdown-item">web development</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../archive/" class="nav-link">归档</a>
                            </li>
                            <li class="navitem">
                                <a href="../about/" class="nav-link">关于</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/dothinking/dothinking.github.io/edit/master/docs/2017-03-08-球面距离与方位角公式的推导：解三角形法.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#_1" class="nav-link">球面距离与方位角公式的推导：解三角形法</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">基本概念</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_3" class="nav-link">球面距离公式</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_4" class="nav-link">方位角公式</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_5" class="nav-link">已知起始点、方位角及距离，求目标位置</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1">球面距离与方位角公式的推导：解三角形法<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>发布于：2017-03-08 | 分类：<a href="../categories/mathematics/">mathematics</a></p>
<hr />
<p>根据地球上任意两地的经纬度，可以计算它们在球面上的最短距离（Great-circle Distance / Orthodromic Distance）
及相对始末位置的方位角（Bearing）。</p>
<p>本文基于地球是标准球体的假设，使用解三角形法（平面三角形和球面三角形）推导上述公式。</p>
<h2 id="_2">基本概念<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><code>纬度</code>是地球上某点与球心的连线与地球赤道面所成的线面角（如图所示<span class="arithmatex"><span class="MathJax_Preview">\varphi</span><script type="math/tex">\varphi</script></span>），北纬为正数，南纬为负数。</p>
</li>
<li>
<p><code>经度</code>是地球上某点经线平面与本初子午面所成的二面角（如图所示的<span class="arithmatex"><span class="MathJax_Preview">\lambda</span><script type="math/tex">\lambda</script></span>），东经为正数，西经为负数。</p>
</li>
<li>
<p><code>方位角</code>是从某点的指北方向线起，依顺时针方向到目标方向线之间的水平夹角（如图所示<span class="arithmatex"><span class="MathJax_Preview">\theta</span><script type="math/tex">\theta</script></span>）。</p>
</li>
</ul>
<p>球面上两点P、Q的最短距离为过P、Q的大圆对应两点之间的劣弧的长度（如图实线所示<span class="arithmatex"><span class="MathJax_Preview">\overset{\frown}{PQ}</span><script type="math/tex">\overset{\frown}{PQ}</script></span>）。将上述物理量等效到单位球中，如下图所示：</p>
<p><img alt="" src="../images/2017-03-08-01.png" /></p>
<h2 id="_3">球面距离公式<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>球面距离<span class="arithmatex"><span class="MathJax_Preview">d</span><script type="math/tex">d</script></span>的常用计算公式为<code>Haversine</code>公式 <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>：</p>
<p>\begin{align*}
a &amp;= \sin^2\frac{\Delta\varphi}{2} + \cos\varphi_1 \cos\varphi_2 \, sin^2\frac{\Delta\lambda}{2}\\
\delta &amp;= 2\,atan2\frac{\sqrt{a}}{\sqrt{1-a}} \\
d &amp;= R\,\delta\\
\tag{I}
\end{align*}</p>
<p>其中，<span class="arithmatex"><span class="MathJax_Preview">\varphi</span><script type="math/tex">\varphi</script></span>是纬度，<span class="arithmatex"><span class="MathJax_Preview">\lambda</span><script type="math/tex">\lambda</script></span>是经度，<span class="arithmatex"><span class="MathJax_Preview">R</span><script type="math/tex">R</script></span>是地球平均半径（<span class="arithmatex"><span class="MathJax_Preview">R=6371km</span><script type="math/tex">R=6371km</script></span>）。<span class="arithmatex"><span class="MathJax_Preview">\Delta\varphi=\varphi_2-\varphi_1</span><script type="math/tex">\Delta\varphi=\varphi_2-\varphi_1</script></span>，<span class="arithmatex"><span class="MathJax_Preview">\Delta\lambda=\lambda_2-\lambda_1</span><script type="math/tex">\Delta\lambda=\lambda_2-\lambda_1</script></span>
分别为纬度、经度的差值。</p>
<div class="admonition warning">
<p class="admonition-title">注意：</p>
<ul>
<li>代入计算的经、纬度为换算后的弧度值。</li>
<li>公式中反正切函数<code>atan2()</code>区别于常规的<code>atan()</code>。</li>
</ul>
</div>
<p><strong>推导思路</strong>：求出<span class="arithmatex"><span class="MathJax_Preview">\overset{\frown}{PQ}</span><script type="math/tex">\overset{\frown}{PQ}</script></span>对应的球心角<span class="arithmatex"><span class="MathJax_Preview">\delta</span><script type="math/tex">\delta</script></span>，然后使用<span class="arithmatex"><span class="MathJax_Preview">d = R\,\delta</span><script type="math/tex">d = R\,\delta</script></span>求出球面距离。</p>
<p>在球面三角形NPQ中直接使用球面三角形的余弦定理（Spherical law of cosines）<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> <sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup></p>
<p>\begin{equation*}
  \cos\delta = \sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda
  \tag{*}\label{eq:1}
\end{equation*}</p>
<p>上式即可求出<span class="arithmatex"><span class="MathJax_Preview">\overset{\frown}{PQ}</span><script type="math/tex">\overset{\frown}{PQ}</script></span>对应的球心角，但是，当P、Q相邻很近（例如，数米之间）即<span class="arithmatex"><span class="MathJax_Preview">\delta</span><script type="math/tex">\delta</script></span>趋近于0时，<span class="arithmatex"><span class="MathJax_Preview">\cos\delta</span><script type="math/tex">\cos\delta</script></span>将趋近于1（0.99999999）。
其后果是对于低浮点精度（low floating-point precision）的计算设备，可能由于舍入误差而造成错误的结果。当然，对于现代的64位浮点数运算
的计算机，一般不会出现上述问题。</p>
<p>为了使上述公式具有更好的计算兼容性，在<span class="arithmatex"><span class="MathJax_Preview">\Delta{OPQ}</span><script type="math/tex">\Delta{OPQ}</script></span>中使用平面三角形余弦定理</p>
<p>\begin{align*}
{PQ}^2 &amp;= {OP}^2 + {OQ}^2 - 2\,{OP}\,{OQ}\,\cos\delta \\
       &amp;= 2 - 2\,( \sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda )\\
       &amp;= 2 - 2\,\left[ \sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2 \left( 1-2\,\sin^2\frac{\Delta\lambda}{2} \right) \right ]\\
       &amp;= 2 - 2(\sin\varphi_1 \sin\varphi_2 + \cos\varphi_1 \cos\varphi_2) + 4\,\cos\varphi_1 \cos\varphi_2\,\sin^2\frac{\Delta\lambda}{2} \\
       &amp;= 2\,\left( 1-\cos\Delta\varphi \right)  + 4\,\cos\varphi_1 \cos\varphi_2 \,\sin^2\frac{\Delta\lambda}{2} \\
       &amp;= 4\,\sin^2\frac{\Delta\varphi}{2} + 4\,\cos\varphi_1 \cos\varphi_2 \,\sin^2\frac{\Delta\lambda}{2} \\
\end{align*}</p>
<p>令<span class="arithmatex"><span class="MathJax_Preview">a=(PQ/2)^2</span><script type="math/tex">a=(PQ/2)^2</script></span>，则上式写为：</p>
<div class="arithmatex">
<div class="MathJax_Preview">
a = \sin^2\frac{\Delta\varphi}{2} + \cos\varphi_1 \cos\varphi_2 \,\sin^2\frac{\Delta\lambda}{2}
</div>
<script type="math/tex; mode=display">
a = \sin^2\frac{\Delta\varphi}{2} + \cos\varphi_1 \cos\varphi_2 \,\sin^2\frac{\Delta\lambda}{2}
</script>
</div>
<p>进而得到球心角<span class="arithmatex"><span class="MathJax_Preview">\delta</span><script type="math/tex">\delta</script></span>为：</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\delta = 2\,atan2\frac{\sqrt{a}}{\sqrt{1-a}}
</div>
<script type="math/tex; mode=display">
\delta = 2\,atan2\frac{\sqrt{a}}{\sqrt{1-a}}
</script>
</div>
<div class="admonition note">
<p class="admonition-title">说明：</p>
<p>以上关于角度的推导基于单位球，即<span class="arithmatex"><span class="MathJax_Preview">OP=OQ=1</span><script type="math/tex">OP=OQ=1</script></span>。</p>
</div>
<h2 id="_4">方位角公式<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>方位角<span class="arithmatex"><span class="MathJax_Preview">\theta</span><script type="math/tex">\theta</script></span>的计算公式：</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\theta = atan2\frac{\sin\Delta\lambda \cos\varphi_2}{\cos\varphi_1 \sin\varphi_2-\sin\varphi_1 \cos\varphi_2\,\cos\Delta\lambda}
\tag{II}
</div>
<script type="math/tex; mode=display">
\theta = atan2\frac{\sin\Delta\lambda \cos\varphi_2}{\cos\varphi_1 \sin\varphi_2-\sin\varphi_1 \cos\varphi_2\,\cos\Delta\lambda}
\tag{II}
</script>
</div>
<p><strong>推导思路</strong>：球面三角形的正弦定理和余弦定理。 </p>
<p>在球面三角形NPQ中分别使用正弦定理和余弦定理：</p>
<p>\begin{align*}
\frac{\sin\theta}{\cos\varphi_2} &amp;= \frac{\sin\Delta\lambda}{\sin\delta} \\
\sin\varphi_2 &amp;= \sin\varphi_1 \cos\delta + \cos\varphi_1 \sin\delta \, \cos\theta
\tag{**}\label{eq:2}
\end{align*}</p>
<p>得到：</p>
<p>\begin{align*}
\sin\theta &amp;= \frac{\cos\varphi_2}{\sin\delta} \, \sin\Delta\lambda\\
\cos\theta &amp;= \frac{\sin\varphi_2-\sin\varphi_1 \cos\delta}{\cos\varphi_1 \sin\delta}
\end{align*}</p>
<p>两式相除，并将式\eqref{eq:1}代入得：</p>
<p>\begin{align*}
\tan\theta &amp;= \frac{\sin\Delta\lambda \cos\varphi_1 \cos\varphi_2}{\sin\varphi_2-\sin\varphi_1 \cos\delta} \\
           &amp;= \frac{\sin\Delta\lambda \cos\varphi_1 \cos\varphi_2}{\sin\varphi_2-\left( \sin^2\varphi_1 \sin\varphi_2 + \sin\varphi_1 \cos\varphi_1 \cos\varphi_2 \cos\Delta\lambda  \right)}\\
           &amp;= \frac{\sin\Delta\lambda \cos\varphi_2}{ \cos\varphi_1 \sin\varphi_2 - \sin\varphi_1 \cos\varphi_2 \cos\Delta\lambda}
\end{align*}</p>
<p>取反函数即可得到方位角<span class="arithmatex"><span class="MathJax_Preview">\theta</span><script type="math/tex">\theta</script></span>的表达式。</p>
<h2 id="_5">已知起始点、方位角及距离，求目标位置<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>已知起始点经纬度<span class="arithmatex"><span class="MathJax_Preview">P(\varphi_1,\lambda_1)</span><script type="math/tex">P(\varphi_1,\lambda_1)</script></span>，方向角<span class="arithmatex"><span class="MathJax_Preview">\theta</span><script type="math/tex">\theta</script></span>及球面距离<span class="arithmatex"><span class="MathJax_Preview">d</span><script type="math/tex">d</script></span>，计算目标位置<span class="arithmatex"><span class="MathJax_Preview">Q(\varphi_2,\lambda_2)</span><script type="math/tex">Q(\varphi_2,\lambda_2)</script></span>的公式为：</p>
<p>\begin{align*}
\varphi_2 &amp;= asin \left( \sin\varphi_1 \cos\delta + \cos\varphi_1 \sin\delta \cos\theta \right)\\
\lambda_2 &amp;= \lambda_1 + atan2 \frac{\sin\theta \sin\delta \cos\varphi_1}{\cos\delta-\sin\varphi_1 \sin\varphi_2}
\tag{III}
\end{align*}</p>
<p>其中，球心角<span class="arithmatex"><span class="MathJax_Preview">\delta = d/R</span><script type="math/tex">\delta = d/R</script></span>。</p>
<p><strong>推导思路</strong>：已知两边及夹角，解球面三角形问题。</p>
<p>根据球面三角形NPQ中的余弦定理，即式\eqref{eq:2}中的第二个式子，可直接得到Q点的纬度值<span class="arithmatex"><span class="MathJax_Preview">\varphi_2</span><script type="math/tex">\varphi_2</script></span>。</p>
<p>根据球面三角形NPQ中的正弦定理，即式\eqref{eq:2}中的第一个式子，得到：</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\cos\varphi_2 \sin\Delta\lambda = \sin\theta \sin\delta
</div>
<script type="math/tex; mode=display">
\cos\varphi_2 \sin\Delta\lambda = \sin\theta \sin\delta
</script>
</div>
<p>根据式\eqref{eq:1}可知：</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\cos\varphi_2 \cos\Delta\lambda = \frac{\cos\delta - \sin\varphi_1 \sin\varphi_2}{\cos\varphi_1}
</div>
<script type="math/tex; mode=display">
\cos\varphi_2 \cos\Delta\lambda = \frac{\cos\delta - \sin\varphi_1 \sin\varphi_2}{\cos\varphi_1}
</script>
</div>
<p>以上二式相除：</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\tan\Delta\lambda = \frac{\sin\theta \sin\delta \cos\varphi_1}{\cos\delta - \sin\varphi_1 \sin\varphi_2}
</div>
<script type="math/tex; mode=display">
\tan\Delta\lambda = \frac{\sin\theta \sin\delta \cos\varphi_1}{\cos\delta - \sin\varphi_1 \sin\varphi_2}
</script>
</div>
<p>从上式即可直接解出Q点的经度<span class="arithmatex"><span class="MathJax_Preview">\lambda_2 = \lambda_1 + \Delta\lambda</span><script type="math/tex">\lambda_2 = \lambda_1 + \Delta\lambda</script></span>。</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="http://www.movable-type.co.uk/scripts/latlong.html">Calculate distance, bearing and more between Latitude/Longitude points</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine formula</a>&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><a href="https://en.wikipedia.org/wiki/Spherical_law_of_cosines">Spherical law of cosines</a>&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p><a href="https://en.wikipedia.org/wiki/Spherical_trigonometry">Spherical trigonometry</a>&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2016 - 2021 Dothinking</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
