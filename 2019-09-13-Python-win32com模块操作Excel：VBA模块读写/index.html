<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="dothinking">
        <link rel="canonical" href="https://dothinking.github.io/2019-09-13-Python-win32com%E6%A8%A1%E5%9D%97%E6%93%8D%E4%BD%9CExcel%EF%BC%9AVBA%E6%A8%A1%E5%9D%97%E8%AF%BB%E5%86%99/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Python win32com模块操作Excel：VBA模块读写 - 格致</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">格致</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">分类 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../categories/CAD-CAE%20integration/" class="dropdown-item">CAD/CAE integration</a>
</li>
                                    
<li>
    <a href="../categories/feeling/" class="dropdown-item">feeling</a>
</li>
                                    
<li>
    <a href="../categories/finite%20element%20analysis/" class="dropdown-item">finite element analysis</a>
</li>
                                    
<li>
    <a href="../categories/machine%20learning/" class="dropdown-item">machine learning</a>
</li>
                                    
<li>
    <a href="../categories/mathematics/" class="dropdown-item">mathematics</a>
</li>
                                    
<li>
    <a href="../categories/numeric%20calculation/" class="dropdown-item">numeric calculation</a>
</li>
                                    
<li>
    <a href="../categories/plasticity%20theory/" class="dropdown-item">plasticity theory</a>
</li>
                                    
<li>
    <a href="../categories/process%20automation/" class="dropdown-item">process automation</a>
</li>
                                    
<li>
    <a href="../categories/python-vba-cpp/" class="dropdown-item">python/vba/cpp</a>
</li>
                                    
<li>
    <a href="../categories/web%20development/" class="dropdown-item">web development</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../archive/" class="nav-link">归档</a>
                            </li>
                            <li class="navitem">
                                <a href="../about/" class="nav-link">关于</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/dothinking/dothinking.github.io/edit/master/docs/2019-09-13-Python-win32com模块操作Excel：VBA模块读写.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#python win32comexcelvba" class="nav-link">Python win32com模块操作Excel：VBA模块读写</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">导出模块</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">导入模块</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_3" class="nav-link">创建模块</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_4" class="nav-link">读取模块代码</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_5" class="nav-link">更新模块代码</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_6" class="nav-link">运行宏</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_7" class="nav-link">注意事项</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="python win32comexcelvba">Python win32com模块操作Excel：VBA模块读写<a class="headerlink" href="#python win32comexcelvba" title="Permanent link">&para;</a></h1>
<p>发布于：2019-09-13 | 分类：<a href="../categories/process%20automation/">process automation</a> , <a href="../categories/python-vba-cpp/">python/vba/cpp</a></p>
<hr />
<p>Python有很多强大的第三方库可以读写Excel，例如<code>xlrd</code>、<code>xlwt</code>、<code>xlutils</code>、<code>openpyxl</code>、<code>xlwings</code>等，它们主要在读写方面具备优势，但论起对Excel操作的全面性和基础性，则首推<code>win32com</code>，它是<code>pywin32</code>库 <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> 的一部分。本文以代码片段方式记录使用<code>win32com</code>读写、运行VBA宏代码。</p>
<p>正如直接在Excel VBA工程中操作一样，<code>win32com</code>可以创建、导入、或者导出工作簿中的VBA模块，也可以运行其中的宏。同理，这些操作也受到Excel宏安全性设置的影响，需要考虑相应的宏设置。</p>
<h2 id="_1">导出模块<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p><code>workbook.VBProject.VBComponents</code>获取所有VBA模块，因此可以进行导出/读取内容操作：</p>
<pre class="codehilite"><code>def export_module(wb, module_name, saved_file):
    '''export vba module to file'''
    for comp in wb.VBProject.VBComponents:
        if comp.Name == module_name:
            comp.Export(saved_file)
            return True
    else:
        return False
</code></pre>

<h2 id="_2">导入模块<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>上面<code>Export()</code>方法导出的宏文件是以<code>Attribute VB_Name = "xxxx"</code>开头的，然后才是代码正文。相应地，我们可以先判断第一行得到宏的名称，然后用<code>Import()</code>方法进行导入，并且注意不可重复导入已存在的模块，可以根据需要选择保留或者替换原模块。</p>
<pre class="codehilite"><code>def import_module(wb, module_file):
    '''
        import vba module from *.bas.
        module name is declared in the first line of module_file:
        Attribute VB_Name = &quot;xxxx&quot;
    '''
    # check module name
    with open(module_file, 'r') as f:
        for line in f:
            if line.startswith('Attribute VB_Name'):
                module_name = line.split('&quot;')[-2]
                break
        else:
            raise Exception('Error: Invalid module file.')
    # check modules and remove original one
    for comp in wb.VBProject.VBComponents:
        if comp.Name == module_name:
            print(f'[info] module {module_name} already exists, remove it now.')
            wb.VBProject.VBComponents.Remove(comp)
            break
    # import 
    wb.VBProject.VBComponents.Import(module_file)

    return module_name
</code></pre>

<h2 id="_3">创建模块<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>上面是以文件的形式导入/导出模块代码，当然还可以以文本形式创建、更新模块代码。</p>
<pre class="codehilite"><code>def create_module(wb, name):
    '''Add normal module.'''
    module = wb.VBProject.VBComponents.Add(1)
    module.Name = name
</code></pre>

<h2 id="_4">读取模块代码<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<pre class="codehilite"><code>def get_module(wb, name):
    ''' Get the module content from the workbook. '''
    cm = wb.VBProject.VBComponents(name).CodeModule
    num = cm.CountOfLines
    return cm.Lines(1, num) if num else ''


def get_modules(wb):
    ''' Get all modules contents from the workbook and return a dictionary. '''
    for module in wb.VBProject.VBComponents:
        yield module.Name, module.Type, get_module(module.Name)
</code></pre>

<h2 id="_5">更新模块代码<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<pre class="codehilite"><code>def set_module(wb, name, code):
    ''' update code of specified module '''
    comp = wb.VBProject.VBComponents(name)
    assert comp, f'Module {name} does not exist in the workbook.'

    cm = comp.CodeModule
    num = cm.CountOfLines
    if num &gt; 0:
        cm.DeleteLines(1, num)

    cm.AddFromString(code)

    # save
    wb.Save()
</code></pre>

<h2 id="_6">运行宏<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>VBA中<code>Application.Run()</code>可以运行宏，我们同样可以在<code>win32com</code>模块使用相应的函数。</p>
<pre class="codehilite"><code>def run_macro(wb, macro_name):
    '''run macro embedded in current toll
    :param macro_name: macro name, e.g. workbook_name!mudule_name.sub_name

    if errors exist in the macro, this function will be blocked. so ensure the macro works
    well and insert the following macro at the beginning for safe:

    On Error Resume Next

    '''
    try:
        wb.Application.Run(macro_name)        
    except Exception as e:
        print(e, flush=True)
        return False
    else:
        return True
</code></pre>

<h2 id="_7">注意事项<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="excel">操作宏的Excel设置<a class="headerlink" href="#excel" title="Permanent link">&para;</a></h3>
<p>成功使用<code>win32com</code>操作宏的前提是 <strong>允许访问VBA工程对象模型</strong>：<code>File</code> -&gt; <code>Option</code> -&gt; <code>Trust Center Setting...</code> -&gt; <code>Macro Settings</code>。否则，提示无权获取VBA工程的模块。</p>
<pre class="codehilite"><code>Programmatic access to Visual Basic Project is not trusted.
</code></pre>

<p>除了手动设置上述选项外，还可以程序的方式动态修改：这个选项的开关是注册表项目下<code>AccessVBOM</code>字段控制的，0表示禁用，1表示启用。因此安全的做法是在访问VBA模块前修改该设置，这可以通过Python操作注册表来实现。以Excel 2010为例：</p>
<pre class="codehilite"><code>import win32api
import win32con

def access_VBA_object_model(value):
    '''programmatically enable access to the VBA object module
    :param value: 0-&gt;disabled, 1-&gt;enabled
    '''
    # open registry on Excel2010
    key = win32api.RegOpenKeyEx(win32con.HKEY_CURRENT_USER,
                        'Software\\Microsoft\\Office\\14.0\\Excel\\Security', 0, win32con.KEY_ALL_ACCESS)
    # store original value
    val, _ = win32api.RegQueryValueEx(key,'AccessVBOM') # (value, type)

    # set value:
    # the property name &quot;AccessVBOM&quot; could be check from Registry
    win32api.RegSetValueEx(key, &quot;AccessVBOM&quot;, 0, win32con.REG_DWORD, value)

    # close
    win32api.RegCloseKey(key)

    return val
</code></pre>

<p>上述代码记录了修改前的值，以便处理完后恢复原来的设置。</p>
<h3 id="excel_1">运行宏的Excel设置<a class="headerlink" href="#excel_1" title="Permanent link">&para;</a></h3>
<p>运行宏同样存在安全策略的设置问题。根据系统设置策略，不在信任区域的宏代码可能是默认被禁用的，那么执行上述代码将提示不存在该宏。Excel软件中对应这个设置的操作是：<code>File</code> -&gt; <code>Option</code> -&gt; <code>Trust Center Setting...</code> -&gt; <code>ActiveX Settings</code>，其中有不同的选项例如默认禁用、默认禁用但打开工作簿时给予提醒、全部启用等。</p>
<p>程序中则由<code>Application</code>的<code>AutomationSecurity</code>属性控制：2表示禁用所有宏, 1表示启用所有宏。如果来源确实可靠的话，我们可以在执行宏前启用所有宏，最后修改回之前的设置即可。</p>
<pre class="codehilite"><code>app = win32com.client.Dispatch(&quot;Excel.Application&quot;)
# save original value
origin_val = app.Application.AutomationSecurity
# enable all
app.Application.AutomationSecurity = 1
# run macro here
# ...
# reset
app.Application.AutomationSecurity = origin_val
</code></pre>

<h3 id="_8">更新宏的问题<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>上面更新模块代码的函数<code>set_module(wb, name, code)</code>，有时会出现莫名其妙的问题：在<code>name</code>模块的末尾多出了一对括号<code>()</code>。也就是说准备设置<code>code</code>，结果却是<code>code</code>+<code>()</code>。</p>
<p>根据<code>stackoverflow</code>上的一个提问 <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>，原因在于：<strong><code>win32com</code>处理VBA时无法完全正确地识别VBA的续行符<code>_</code></strong>。</p>
<p>例如，当<code>code</code>中包含下面片段时：</p>
<pre class="codehilite"><code>Private Declare PtrSafe Function foo Lib &quot;bar.dll&quot; _
    Alias &quot;foo_bar&quot; ( _
    ByVal x As Long, _
    ByVal y As Long) As Long
</code></pre>

<p>括号中的两个续行符<code>_</code>可以被正确识别，但第一行孤立的<code>_</code>则出现了问题，于是VBA的自动完成机制导致了最后的一对<code>()</code>。</p>
<p>所以尽量避免出现上述写法，或者强制将末尾的<code>_</code>删除并合并相应的两行。</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://github.com/mhammond/pywin32">Python for Windows (pywin32) Extensions</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="https://stackoverflow.com/questions/58019991/problem-with-addfromstring-function-of-codemodule-in-vba">Problem with AddFromString function of CodeModule in VBA</a>&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2016 - 2021 Dothinking</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
