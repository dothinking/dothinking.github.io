<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="dothinking">
        <link rel="canonical" href="https://dothinking.github.io/2020-07-14-pdf2docx%E5%BC%80%E5%8F%91%E6%A6%82%E8%A6%81%EF%BC%9A%E6%8F%90%E5%8F%96%E6%96%87%E6%9C%AC%E3%80%81%E5%9B%BE%E7%89%87%E5%92%8C%E5%BD%A2%E7%8A%B6/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>pdf2docx开发概要：提取文本、图片和形状 - 格致</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../css/extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">格致</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">分类</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../categories/CAD-CAE%20integration/" class="dropdown-item">CAD/CAE integration</a>
</li>
                                    
<li>
    <a href="../categories/devops/" class="dropdown-item">devops</a>
</li>
                                    
<li>
    <a href="../categories/energy/" class="dropdown-item">energy</a>
</li>
                                    
<li>
    <a href="../categories/feeling/" class="dropdown-item">feeling</a>
</li>
                                    
<li>
    <a href="../categories/finite%20element%20analysis/" class="dropdown-item">finite element analysis</a>
</li>
                                    
<li>
    <a href="../categories/machine%20learning/" class="dropdown-item">machine learning</a>
</li>
                                    
<li>
    <a href="../categories/mathematics/" class="dropdown-item">mathematics</a>
</li>
                                    
<li>
    <a href="../categories/numeric%20calculation/" class="dropdown-item">numeric calculation</a>
</li>
                                    
<li>
    <a href="../categories/optimization/" class="dropdown-item">optimization</a>
</li>
                                    
<li>
    <a href="../categories/plasticity%20theory/" class="dropdown-item">plasticity theory</a>
</li>
                                    
<li>
    <a href="../categories/process%20automation/" class="dropdown-item">process automation</a>
</li>
                                    
<li>
    <a href="../categories/python-vba-cpp/" class="dropdown-item">python/vba/cpp</a>
</li>
                                    
<li>
    <a href="../categories/web%20development/" class="dropdown-item">web development</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../archive/" class="nav-link">归档</a>
                            </li>
                            <li class="nav-item">
                                <a href="../about/" class="nav-link">关于</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/dothinking/dothinking.github.io/edit/master/docs/2020-07-14-pdf2docx开发概要：提取文本、图片和形状.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#pdf2docx" class="nav-link">pdf2docx开发概要：提取文本、图片和形状</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link">文本与图片</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_2" class="nav-link">形状</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_3" class="nav-link">超链接</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_4" class="nav-link">总结</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="pdf2docx">pdf2docx开发概要：提取文本、图片和形状<a class="headerlink" href="#pdf2docx" title="Permanent link">&para;</a></h1>
<p>发布于：2020-07-14 | 分类：<a href="../categories/process%20automation/">process automation</a></p>
<hr />
<p>文本、图片及形状涵盖了常见的PDF元素，这些是<code>pdf2docx</code>的处理对象。本文介绍利用<code>PyMuPDF</code>提取这些页面元素，及其基本数据结构。</p>
<h2 id="_1">文本与图片<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p><code>PyMuPDF</code>的<code>Textpage</code>对象提供的<code>extractDICT()</code>和<code>extractRAWDICT()</code>用以获取页面中的所有文本和图片（内容、位置、属性），基本数据结构如下 <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>：</p>
<p><img alt="文本与图片块结构" src="https://pymupdf.readthedocs.io/en/latest/_images/img-textpage.png" /></p>
<p><code>pdf2docx</code>继续沿用以上数据结构，并稍作改动，作为第一类基本数据<code>Block</code>：</p>
<ul>
<li>
<p>将图片块整合到文本块<code>TextBlock</code>中，作为<code>line</code>&gt;<code>span</code>级别的元素</p>
</li>
<li>
<p>增加布局参数，例如<code>alignment</code>，<code>left_space</code>，<code>before_space</code>，用以保存后续段落布局解析结果</p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>后续版本中发现<code>extractDICT()</code>获取图片存在问题（如只能获取完全显示在页面中的图片、丢失alpha通道），还需配合<code>page.getImageList()</code>处理；另外，v0.5.0版本中对浮动图片也进行了支持，详见以下两篇图片相关的记录。</p>
<blockquote>
<p><a href="../2020-10-15-pdf2docx%E5%BC%80%E5%8F%91%E6%A6%82%E8%A6%81%EF%BC%9A%E8%8E%B7%E5%8F%96%E5%9B%BE%E7%89%87%E5%8F%8A%E5%85%B6%E4%BD%8D%E7%BD%AE/">pdf2docx开发概要：获取图片及其位置</a></p>
<p><a href="../2020-10-25-pdf2docx%E5%BC%80%E5%8F%91%E6%A6%82%E8%A6%81%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%B5%AE%E5%8A%A8%E5%9B%BE%E7%89%87/">pdf2docx开发概要：创建浮动图片</a></p>
</blockquote>
</div>
<h2 id="_2">形状<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>文本与图片构成了主体内容，它们的样式则由 <strong>形状</strong> 来描述，例如代表文本高亮的矩形块，表明表格边线的直线（很细的矩形）。形状构成了<code>pdf2docx</code>的第二类基本数据<code>Shape</code>。</p>
<p>这里的所谓的形状具体指两类来源：</p>
<ul>
<li>
<p>PDF原始文件中的路径<code>Path</code></p>
</li>
<li>
<p>PDF注释<code>Annotation</code></p>
</li>
</ul>
<h3 id="a">(a) 路径<a class="headerlink" href="#a" title="Permanent link">&para;</a></h3>
<p>PDF规范定义了各种路径及其围成的图形（描边和填充），但截至1.17.3版本，<code>PyMuPDF</code>尚未提供解析具体路径的API，只能提取这些路径的原始代码（参考以下输出示例）。</p>
<pre class="highlight"><code class="language-python">pdf = fitz.open(file_path)
for page in pdf:
    for xref in page._getContents():
        page_content = pdf._getXrefStream(xref).decode(encoding="ISO-8859-1")

# 输出示例
/P&lt;&lt;/MCID 0&gt;&gt; BDC
...
1 0 0 1 90.0240021 590.380005 cm
...
1 1 0 rg # or 0 g
...
285.17 500.11 193.97 13.44 re f*
...
214 320 m
249 322 l
...
EMC</code></pre>
<p>因此需要参考厚厚的PDF规范 <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>，自行从原始内容中解析。例如：</p>
<ul>
<li><code>cm</code>：坐标变换，本例(0,0)平移至(90.0240021 590.380005)</li>
<li><code>q</code>/<code>Q</code>：保存/调出画笔</li>
<li><code>rg</code>/<code>g</code>：指定颜色模式：RGB/灰度</li>
<li><code>re</code>, <code>f</code>/<code>f*</code>: 使用预定颜色填充矩形路径。如果没有<code>f</code>/<code>f*</code>，则仅仅是矩形路径而不进行填充。本例中，<ul>
<li>填充黄色 (1,1,0)</li>
<li>矩形左下角: (285.17 500.11)</li>
<li>宽度: 193.97 Pt</li>
<li>高度: 13.44 Pt</li>
</ul>
</li>
<li><code>m</code>, <code>l</code>: 从<code>m</code>向<code>l</code>画直线路径；后续可以继续<code>l</code>，表示多边形路径</li>
<li><code>c</code>, <code>v</code>, <code>y</code>: 根据控制点画贝塞尔曲线路径</li>
</ul>
<p>关于坐标变换，也就是从PDF中提取的一个坐标映射到<code>PyMuPDF</code>处理的坐标，需要注意：
- PDF规范定义了一个原始的PDF坐标系（原点在左下角），<code>cm</code>定义了此坐标系下的变换矩阵
- <code>PyMuPDF</code>定义了<code>fitz</code>坐标系（原点左上角，页面旋转角度0），从PDF坐标系到<code>fitz</code>坐标系的变换矩阵<code>page.transformationMatrix</code>
- 真实页面可能存在旋转角度，所以<code>fitz</code>坐标系到真实页面坐标系的变换矩阵<code>page.rotationMatrix</code></p>
<p>上述的PDF路径解析是一个复杂的工程，<code>pdf2docx</code>提供了简化版的解析函数，可以提取出常规的路径坐标、颜色、描边/填充状态。其中，我们只关注水平或者竖直的路径，因为只有它们对接下来的表格、文本样式解析有意义。</p>
<p>至于其他的曲线路径，实际上组成了矢量图形，<code>pdf2docx</code>将其转化为位图，便于插入到<code>docx</code>文档中，具体参考下文：</p>
<blockquote>
<p><a href="../2021-06-26-pdf2docx%E5%BC%80%E5%8F%91%E6%A6%82%E8%A6%81%EF%BC%9A%E7%9F%A2%E9%87%8F%E5%9B%BE%E5%A4%84%E7%90%86/">pdf2docx开发概要：矢量图处理</a></p>
</blockquote>
<h3 id="b">(b) 形状注释<a class="headerlink" href="#b" title="Permanent link">&para;</a></h3>
<p>在PDF文件基础上进行的批注操作例如高亮、下划线，可以直接使用<code>Page</code>对象的<code>annots()</code>方法获取，其中的<code>type</code>属性表明了该批注的类型 <sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>。例如，<code>pdf2docx</code>关心的有：</p>
<pre class="codehilite"><code>PDF_ANNOT_LINE 3
PDF_ANNOT_SQUARE 4
PDF_ANNOT_HIGHLIGHT 8
PDF_ANNOT_UNDERLINE 9
PDF_ANNOT_STRIKEOUT 11
</code></pre>

<p>综合以上两类形状（路径和注释），将其分为两类：</p>
<ul>
<li><strong>描边</strong>（<code>Stroke</code>）即较细的矩形，表征表格边框线、文字下划线、删除线等样式</li>
<li><strong>填充</strong>（<code>Fill</code>）即普通矩形，表征单元格背景色、文本高亮等样式</li>
</ul>
<p>相应数据结构如下：</p>
<pre class="highlight"><code class="language-python"># Stroke
{
    'type': int,    
    'start': (x0, y0),
    'end': (x1, y1),
    'width': w,
    'bbox': (x0+w/2, y0+w/2, x1+w/2, y1+w/2),
    'color': int  # e.g. 16711680
}

# Fill
{
    'type': int,
    'bbox': (x0, y0, x1, y1),
    'color': int  # e.g. 16711680    
}</code></pre>
<p>其中，<code>type</code>表示语义上的分类，即上述提及的表格样式（边框、背景色）、文本样式（高亮、下划线、删除线）。</p>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>从1.18.0版本开始，<code>PyMuPDF</code>提供了获取页面内所有路径（包括Annotation）的函数<code>page.getDrawings()</code> 。虽然该方法尚不稳定（如丢失某些路径、不支持裁剪的路径），但可以使以上解析路径的过程大大简化，因此<code>pdf2docx</code>从v0.5.0开始使用该函数。</p>
</div>
<h2 id="_3">超链接<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p><code>PyMuPDF</code>可以通过<code>page.getLinks()</code>提取超链接，得到超链接文本、URI和作用区域（矩形坐标）。为了将超链接添加到相应的文本上去，<code>pdf2docx</code>将其作为一种虚拟的形状<code>Hyperlink</code>。</p>
<pre class="codehilite"><code># hyperlink
{
    'type': HYPERLINK,    
    'bbox': (x0, y0, x1, y1),
    'uri': str
}
</code></pre>

<div class="admonition warning">
<p class="admonition-title">注意</p>
<p><code>Hyperlink</code>类似于<code>Stroke</code>，本质区别在于<code>Hyperlink</code>的语义类型是已知的。更一般地理解，<code>Stroke</code>是一种几何类型，事先并不知道它的语义类型（边框、删除线还是下划线？）；而<code>Hyperlink</code>是一种确定了语义类型的<code>Stroke</code>。</p>
</div>
<h2 id="_4">总结<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>借助<code>PyMuPDF</code>从PDF提取文本、图片和形状数据，它们构成了<code>pdf2docx</code>的两类基础数据：</p>
<ul>
<li>
<p>块元素<code>Block</code>，代表主体内容，例如直接提取出的文本/图片组成的<code>TextBlock</code>，以及后续解析得到的表格结构<code>TableBlock</code>。</p>
</li>
<li>
<p>形状元素<code>Shape</code>，代表格式内容，例如描边<code>Stroke</code>将对应下划线、表格边框等，填充<code>Fill</code>将对应文本高亮、单元格背景色等。</p>
</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://pymupdf.readthedocs.io/en/latest/textpage.html">TextPage</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdf_reference_archive/pdf_reference_1-7.pdf">PDF Reference 1.7</a>&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><a href="https://pymupdf.readthedocs.io/en/latest/vars.html#annotation-types">Annotation Types</a>&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2016 - 2021 Dothinking</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
