<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="dothinking">
        <link rel="canonical" href="https://dothinking.github.io/2021-08-22-%E4%BD%9C%E4%B8%9A%E8%BD%A6%E9%97%B4%E8%B0%83%E5%BA%A6%E9%97%AE%E9%A2%98%E6%B1%82%E8%A7%A3%E6%A1%86%E6%9E%B6%EF%BC%9AOR-Tools%E7%BA%A6%E6%9D%9F%E6%B1%82%E8%A7%A3%E5%99%A8/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>作业车间调度问题求解框架：OR-Tools 约束求解器 - 格致</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">格致</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">分类 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../categories/CAD-CAE%20integration/" class="dropdown-item">CAD/CAE integration</a>
</li>
                                    
<li>
    <a href="../categories/devops/" class="dropdown-item">devops</a>
</li>
                                    
<li>
    <a href="../categories/feeling/" class="dropdown-item">feeling</a>
</li>
                                    
<li>
    <a href="../categories/finite%20element%20analysis/" class="dropdown-item">finite element analysis</a>
</li>
                                    
<li>
    <a href="../categories/machine%20learning/" class="dropdown-item">machine learning</a>
</li>
                                    
<li>
    <a href="../categories/mathematics/" class="dropdown-item">mathematics</a>
</li>
                                    
<li>
    <a href="../categories/numeric%20calculation/" class="dropdown-item">numeric calculation</a>
</li>
                                    
<li>
    <a href="../categories/optimization/" class="dropdown-item">optimization</a>
</li>
                                    
<li>
    <a href="../categories/plasticity%20theory/" class="dropdown-item">plasticity theory</a>
</li>
                                    
<li>
    <a href="../categories/process%20automation/" class="dropdown-item">process automation</a>
</li>
                                    
<li>
    <a href="../categories/python-vba-cpp/" class="dropdown-item">python/vba/cpp</a>
</li>
                                    
<li>
    <a href="../categories/web%20development/" class="dropdown-item">web development</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../archive/" class="nav-link">归档</a>
                            </li>
                            <li class="navitem">
                                <a href="../about/" class="nav-link">关于</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/dothinking/dothinking.github.io/edit/master/docs/2021-08-22-作业车间调度问题求解框架：OR-Tools约束求解器.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#or-tools" class="nav-link">作业车间调度问题求解框架：OR-Tools 约束求解器</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#or-tools_1" class="nav-link">OR-Tools</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">数学模型</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#or-tools_2" class="nav-link">OR-Tools 模型</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#jsp_framework" class="nav-link">基于 jsp_framework 实现</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">计算实例</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="or-tools">作业车间调度问题求解框架：OR-Tools 约束求解器<a class="headerlink" href="#or-tools" title="Permanent link">&para;</a></h1>
<p>发布于：2021-08-22 | 分类：<a href="../categories/optimization/">optimization</a> , <a href="../categories/mathematics/">mathematics</a></p>
<hr />
<p>本文根据作业车间调度问题的数学描述，利用 Google 的整数规划求解器 <code>OR-Tools</code> 进行求解，作为 <code>jsp_framework</code> 内置的第一个求解器。</p>
<h2 id="or-tools_1">OR-Tools<a class="headerlink" href="#or-tools_1" title="Permanent link">&para;</a></h2>
<p><code>OR-Tools</code> 是 Google 基于 C++ 开发的针对组合优化问题的求解库，同时支持 Python，C#，或 Java 语言的调用。</p>
<blockquote>
<p><a href="https://developers.google.cn/optimization/">https://developers.google.cn/optimization/</a></p>
</blockquote>
<p>作为Python库，支持<code>pip</code>一键安装。</p>
<pre class="highlight"><code class="language-python">pip install ortools</code></pre>
<h2 id="_1">数学模型<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p><a href="../2021-08-08-%E4%BD%9C%E4%B8%9A%E8%BD%A6%E9%97%B4%E8%B0%83%E5%BA%A6%E9%97%AE%E9%A2%98%E6%B1%82%E8%A7%A3%E6%A1%86%E6%9E%B6%EF%BC%9A%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0/">前文</a>给出了作业车间调度问题的两种典型描述，其中数学模型描述为：</p>
<p>\begin{align*}
&amp;\min\,\, c_{m} = \max \left \{ c_{ij} \, | \, (i,j) \in \mathbb{O} \right \} \\
\\
&amp;s.t.\quad
\begin{cases}
c_{ij} \geq p_{ij} &amp; (i,j) \in \mathbb{O} \\
\\
c_{ij}-c_{kj} \geq p_{ij} &amp; if \,\, (k,j) \rightarrow (i,j), \,\, i, k \in \mathbb{M}^j \\
\\
c_{ij} - c_{ik} \geq p_{ij} \,\, or \,\, c_{ik}-c_{ij}  \geq p_{ik} &amp; (i,j), (i,k) \in \mathbb{O}, \,\, j \neq k
\end{cases}
\end{align*}</p>
<p>具体变量说明参考原文，其中两个基本变量：</p>
<ul>
<li><span><span class="MathJax_Preview">c_{ij}</span><script type="math/tex">c_{ij}</script></span> 表示工序 <span><span class="MathJax_Preview">(i,j)</span><script type="math/tex">(i,j)</script></span> 即作业 <span><span class="MathJax_Preview">j</span><script type="math/tex">j</script></span> 的某个在机器 <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span> 上进行的工序的完成时间</li>
<li><span><span class="MathJax_Preview">p_{ij}</span><script type="math/tex">p_{ij}</script></span> 表示作业 <span><span class="MathJax_Preview">j</span><script type="math/tex">j</script></span> 的某个在机器 <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span> 上进行的工序所需的加工时间</li>
</ul>
<p>三个约束中：</p>
<ul>
<li>第一个表明工序的开始时间非负</li>
<li>第二个是工序序列约束，即同一个作业的相邻工序必须满足先后顺序</li>
<li>第三个是资源约束，即每一台机器在某个时刻只能加工一道工序</li>
</ul>
<h2 id="or-tools_2"><code>OR-Tools</code> 模型<a class="headerlink" href="#or-tools_2" title="Permanent link">&para;</a></h2>
<p>使用 <code>OR-Tools</code> 的步骤为：用内置语言建立模型例如定义变量、约束及目标函数，然后使用内置或者第三方求解器求解。</p>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p><code>OR-Tools</code> 使用 <code>CP-SAT</code> 约束求解器求解作业车间调度问题。<code>CP-SAT</code> 求解器仅支持整数变量。</p>
</div>
<p>上一节数学模型中将工序完工时刻作为求解变量，为了建模方便，这里为每个工序创建两个变量 <span><span class="MathJax_Preview">s_{ij}</span><script type="math/tex">s_{ij}</script></span> 和 <span><span class="MathJax_Preview">c_{ij}</span><script type="math/tex">c_{ij}</script></span>，分别表示开始时刻和结束时刻。<code>OR-Tools</code> 内置了 <code>NewIntVar</code> 整数变量，根据函数签名可知，我们需要指定变量名及变量范围 <span><span class="MathJax_Preview">[lb, ub]</span><script type="math/tex">[lb, ub]</script></span>。</p>
<pre class="highlight"><code class="language-python">def NewIntVar(self, lb, ub, name): pass</code></pre>
<p>基于这些变量，</p>
<ul>
<li>用<code>AddMaxEquality</code>取 <span><span class="MathJax_Preview">c_{ij}</span><script type="math/tex">c_{ij}</script></span> 的最大值然后最小化得到目标函数</li>
<li>定义变量下限 <span><span class="MathJax_Preview">lb \geq 0</span><script type="math/tex">lb \geq 0</script></span> 即可满足第一个非负的约束条件</li>
<li>第二个约束条件基于前后工序的 <span><span class="MathJax_Preview">s_{ij}</span><script type="math/tex">s_{ij}</script></span> 和 <span><span class="MathJax_Preview">c_{ij}</span><script type="math/tex">c_{ij}</script></span> 实现</li>
</ul>
<p>为了实施第三个约束条件，即同一机器上的任意两个工序不重叠，需要用到 <code>OR-Tools</code> 的 <strong>区间变量</strong> <code>NewIntervalVar</code>。针对不可重叠的所有工序/区间，直接施加内置的 <code>NoOverlap</code> 约束。</p>
<pre class="highlight"><code class="language-python">def NewIntervalVar(self, start, size, end, name): pass</code></pre>
<p>其中，<code>start</code>、<code>end</code> 及 <code>size</code> 分别表示区间的开始、结束位置及区间的大小，并且始终满足 <span><span class="MathJax_Preview">start + size = end</span><script type="math/tex">start + size = end</script></span>。对于本问题，<code>start</code>、<code>end</code> 为上一步的 <span><span class="MathJax_Preview">s_{ij}</span><script type="math/tex">s_{ij}</script></span> 和 <span><span class="MathJax_Preview">c_{ij}</span><script type="math/tex">c_{ij}</script></span>，<code>size</code> 为工序加工时间常量。</p>
<h2 id="jsp_framework">基于 <code>jsp_framework</code> 实现<a class="headerlink" href="#jsp_framework" title="Permanent link">&para;</a></h2>
<p><code>OR-Tools</code> 的官方文档提供了一个求解作业车间调度问题的 <a href="https://developers.google.cn/optimization/scheduling/job_shop">完整案例</a>，本文将基于本系列的 <code>jsp_framework</code> 实现。</p>
<ul>
<li>
<p>基本流程（参考 <a href="../2021-08-14-%E4%BD%9C%E4%B8%9A%E8%BD%A6%E9%97%B4%E8%B0%83%E5%BA%A6%E9%97%AE%E9%A2%98%E6%B1%82%E8%A7%A3%E6%A1%86%E6%9E%B6%EF%BC%9APython%E5%BB%BA%E6%A8%A1/">Python建模</a> 部分）：</p>
<p>自定义一个继承自 <code>JSSolver</code> 的 <code>GoogleORCPSolver</code> 类，然后重点实现 <code>do_solve()</code> 方法。</p>
</li>
<li>
<p>完整代码参考：</p>
<blockquote>
<p><a href="https://github.com/dothinking/jsp_framework/blob/dev/jsp_fwk/solver/ortools.py">https://github.com/dothinking/jsp_framework/blob/dev/jsp_fwk/solver/ortools.py</a></p>
</blockquote>
</li>
</ul>
<p>其中，</p>
<ul>
<li>
<p>为了避免求解规模太大而失去响应，人为设定运行时间的上限：</p>
<pre class="highlight"><code class="language-python">solver.parameters.max_time_in_seconds = 300.0</code></pre>
</li>
<li>
<p>为了实时输出当前最优解，定义如下执行回调函数的类：</p>
<pre class="highlight"><code class="language-python">
class VarArraySolutionPrinter(cp_model.CpSolverSolutionCallback):
    '''Output intermediate solutions.'''
    def __init__(self, variables:dict, problem:JSProblem, solution:JSSolution):
        '''Initialize with variable map: operation step -&gt; OR-Tools variable.'''
        cp_model.CpSolverSolutionCallback.__init__(self)
        self.__variables = variables
        self.__problem = problem
        self.__solution = solution

    def on_solution_callback(self):
        '''Pass data back to domain class.'''
        # assign OR-Tools solution back to JSPSolution
        for op, var in self.__variables.items():
            op.update_start_time(self.Value(var.start))

        # update solution
        self.__problem.update_solution(self.__solution)</code></pre>
<p>相应地，将普通的求解方式：</p>
<pre class="highlight"><code class="language-python">status = solver.Solve(model)</code></pre>
<p>改为：</p>
<pre class="highlight"><code class="language-python">solution_printer = VarArraySolutionPrinter(variables, problem, solution)
status = solver.SolveWithSolutionCallback(model, solution_printer)</code></pre>
</li>
</ul>
<h2 id="_2">计算实例<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>最后，求解几个标准问题。求解时间上限设定为300秒。</p>
<pre class="highlight"><code class="language-python">from jsp_fwk import (JSProblem, JSSolution)
from jsp_fwk.solver import GoogleORCPSolver

# benchmarks
names = ['ft06', 'la01', 'ft10', 'swv01', 'la38', \
        'ta31', 'swv12', 'ta42', 'ta54', 'ta70']

res = []
res.append('name,num_job,num_machine,optimum,solution,time')
for name in names:
    p = JSProblem(benchmark=name)
    s = GoogleORCPSolver(max_time=300) # set upper limit of solving time
    s.solve(problem=p, interval=None)

    # wait for termination
    while True:
        if not s.is_running: break

    # collect results
    items = [name, len(p.jobs), len(p.machines), p.optimum, \
                p.solution.makespan, s.user_time]
    res.append(','.join(map(str, items)))

print(res)</code></pre>
<p>结果如下表所示：</p>
<ul>
<li>
<p>前5行变量总数300以内，<code>OR-Tools</code> 基本得到了最优解。例4虽然没能在规定时间内求得最优解，但是相对误差0.5%已经很小。</p>
</li>
<li>
<p>后5行变量总数在<span><span class="MathJax_Preview">[450, 1000]</span><script type="math/tex">[450, 1000]</script></span>量级，都没能在300秒内求得最优解，并且精度随着问题复杂度（例如变量总数、工序数等）增加而急剧降低。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>name</th>
<th>num of <br> job</th>
<th>num of <br> machine</th>
<th>optimum</th>
<th>solution</th>
<th>err / %</th>
<th>time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>ft06</td>
<td>6</td>
<td>6</td>
<td>55</td>
<td>55</td>
<td>0.0</td>
<td>0.8</td>
</tr>
<tr>
<td>2</td>
<td>la01</td>
<td>10</td>
<td>5</td>
<td>666</td>
<td>666</td>
<td>0.0</td>
<td>6.8</td>
</tr>
<tr>
<td>3</td>
<td>ft10</td>
<td>10</td>
<td>10</td>
<td>930</td>
<td>930</td>
<td>0.0</td>
<td>20.6</td>
</tr>
<tr>
<td>4</td>
<td>swv01</td>
<td>20</td>
<td>10</td>
<td>1407</td>
<td>1414</td>
<td>0.5</td>
<td>300.1</td>
</tr>
<tr>
<td>5</td>
<td>la38</td>
<td>15</td>
<td>15</td>
<td>1196</td>
<td>1196</td>
<td>0</td>
<td>193.5</td>
</tr>
<tr>
<td>6</td>
<td>ta31</td>
<td>30</td>
<td>15</td>
<td>1764</td>
<td>1891</td>
<td>7.2</td>
<td>300.1</td>
</tr>
<tr>
<td>7</td>
<td>swv12</td>
<td>50</td>
<td>10</td>
<td>(2972, 3003)</td>
<td>3339</td>
<td>11.8</td>
<td>300.1</td>
</tr>
<tr>
<td>8</td>
<td>ta42</td>
<td>30</td>
<td>20</td>
<td>(1867, 1956)</td>
<td>2546</td>
<td>33.2</td>
<td>300.1</td>
</tr>
<tr>
<td>9</td>
<td>ta54</td>
<td>50</td>
<td>15</td>
<td>2839</td>
<td>3192</td>
<td>12.4</td>
<td>299.7</td>
</tr>
<tr>
<td>10</td>
<td>ta70</td>
<td>50</td>
<td>20</td>
<td>2995</td>
<td>3948</td>
<td>31.8</td>
<td>299.0</td>
</tr>
</tbody>
</table>
<p>问题规模较小时，高效求出最优解；但随着问题规模的增大，求解效率急剧下降。这是整数规划等精确求解方法应用于实际大规模调度问题的限制所在。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2016 - 2021 Dothinking</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
